"use client";
import { Program, AnchorProvider, setProvider, Wallet } from "@coral-xyz/anchor";
import { useConnection, useWallet, useAnchorWallet } from "@solana/wallet-adapter-react";
import { Connection, Keypair, PublicKey } from '@solana/web3.js';
import idl from '@/../vote/target/idl/vote.json';
import type { Vote } from '@/../vote/target/types/vote';
import { Button } from "antd";
import { useEffect, useState } from "react";

export default function Page() {
	const { publicKey, sendTransaction } = useWallet();
	const { connection } = useConnection();
	const [ poll, setPoll ] = useState<any>(null);
	const wallet = useAnchorWallet();
	if (!wallet) return null;
	const provider = new AnchorProvider(connection, wallet, {
		commitment: "confirmed",
	  });
	setProvider(provider);
	 const program = new Program(idl as Vote, provider);

	const initializeAccount = async () => {
		const poll = Keypair.generate();
		const value = await program.account.pollId.all();
		let transaction;
		if (value.length == 0) {
			const pollId = Keypair.generate();
			transaction = await program.methods
			.createPoll("Fesse", "caca")
			.accounts({poll: poll.publicKey, pollId: pollId.publicKey, signer: wallet.publicKey})
			.signers([poll, pollId])
			.rpc();
		}
		// else {
		// 	const pollId = value[0].publicKey;
		// 	transaction = await program.methods
		// 	.createPoll("Fesse", "caca")
		// 	.accounts({poll: poll.publicKey, pollId: pollId, signer: wallet.publicKey})
		// 	.signers([poll, value[0]])
		// 	.rpc();
		// }

		console.log(`Transaction signature: ${transaction}`);
		console.log(`Compte initialisÃ© avec l'adresse: ${poll.publicKey}`);
	};
	const fetchData = async () => {
		const data = await program.account.poll.all();
		const value = await program.account.pollId.all();
		console.log("value:", value.length);
		setPoll(data);
		console.log(poll);
	};
	  
	const pollPrint = () => {
		return (poll ? poll.map((p: any) => {
			return (
				<div key={p.publicKey.toString()} className="border p-4 my-4">
					<h1>Name: {p.account.pollName}</h1>
					<p>Description: {p.account.pollDescription}</p>
					<p>Against: {p.account.against}</p>
					<p>For: {p.account.for}</p>
					<p>Candidate Amount: {p.account.candidateAmount}</p>
					<p>Address: {p.publicKey.toString()}</p>
				</div>
			)
		}) : "Vide")
	};
  return (
	<div>
	  <h1>Test</h1>
	  <p>Generated by create-solana-dapp</p>
	  {poll ? pollPrint() : "Vide"}
	  <Button onClick={initializeAccount}>Initialize Account</Button>
	  <Button onClick={fetchData}>Fetch Data</Button>
	</div>
  );
}